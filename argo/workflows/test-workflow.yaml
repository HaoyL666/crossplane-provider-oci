#   argo submit argo/workflows/test-workflow.yaml \
#     -p clone_repo=true \
#     -p delete_crossplane=true \
#     -p setup_crossplane=true \
#     -p setup_uptest=false \
#     -p create_compartment=true \
#     -p git_ref=argo-workflow \
#     -p git_repo=https://github.com/endurthiabhilash/crossplane-provider-oci.git \
#     -p tenancy=ocid1.tenancy.oc1.xxx \
#     -p compartment_id=ocid1.compartment.oc1.xxx \
#     -p image_id=ocid1.image.oc1.xxx

apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: oci-crossplane-test-
spec:
  serviceAccountName: argo-workflow
  entrypoint: crossplane-workflow
  volumes:
    - name: git-repo
      persistentVolumeClaim:
        claimName: git-repo-pvc
  arguments:
    parameters:
    - name: clone_repo
      value: "false"
    - name: delete_crossplane
      value: "false"
    - name: setup_crossplane
      value: "false"
    - name: setup_uptest
      value: "false"
    - name: create_compartment
      value: "false"
    - name: run_tests
      value: "false"

    # Required to clone the Crossplane OCI provider repo
    - name: git_repo
      value: https://github.com/oracle/crossplane-provider-oci.git
    - name: git_ref
      value: main
    
    # Required by scripts/setup-crossplane.sh
    - name: namespace
      value: crossplane-system
    - name: region
      value: us-ashburn-1
    - name: providers
      value: "provider-family-oci,provider-oci-certificatesmanagement,provider-oci-containerengine,provider-oci-identity,provider-oci-kms,provider-oci-loadbalancer,provider-oci-networking,provider-oci-networkloadbalancer,provider-oci-objectstorage"
    - name: provider-image-repo-name
      value: ghcr.io/oracle
    - name: family-provider-version
      value: v0.0.2
    - name: tenancy

    # Required by create-compartment task
    - name: compartment_id

    # Required by create-node-pool task
    - name: image_id

  templates:
    - name: crossplane-workflow
      dag:
        tasks:
        - name: delete-crossplane
          templateRef: 
            name: crossplane-template
            template: delete-crossplane
          when: "{{workflow.parameters.delete_crossplane}} == true"
          arguments: 
            parameters: 
              - name: namespace
                value: "{{workflow.parameters.namespace}}"
        - name: clone-repo
          templateRef: 
            name: clone-repo-template
            template: clone-repo
          when: "{{workflow.parameters.clone_repo}} == true"
          arguments: 
            parameters: 
              - name: git_repo
                value: "{{workflow.parameters.git_repo}}"
              - name: git_ref
                value: "{{workflow.parameters.git_ref}}"
        - name: check-contents
          templateRef: 
            name: clone-repo-template
            template: check-contents
          dependencies: [clone-repo]
        - name: setup-crossplane
          templateRef: 
            name: crossplane-template
            template: setup-crossplane
          dependencies: [clone-repo, delete-crossplane]
          when: "{{workflow.parameters.setup_crossplane}} == true"
          arguments:
            parameters:
              - name: namespace
                value: "{{workflow.parameters.namespace}}"
              - name: region
                value: "{{workflow.parameters.region}}"
              - name: providers
                value: "{{workflow.parameters.providers}}"
              - name: provider-image-repo-name
                value: "{{workflow.parameters.provider-image-repo-name}}"
              - name: family-provider-version
                value: "{{workflow.parameters.family-provider-version}}"
              - name: tenancy
                value: "{{workflow.parameters.tenancy}}"
