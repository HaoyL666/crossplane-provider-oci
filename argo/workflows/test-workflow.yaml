#   argo submit argo/workflows/test-workflow.yaml \
#     -p clone_repo=true \
#     -p delete_crossplane=true \
#     -p setup_crossplane=true \
#     -p git_ref=argo-workflow \
#     -p git_repo=https://github.com/endurthiabhilash/crossplane-provider-oci.git \
#     -p run_identity_tests=true \
#     -p run_network_tests=true \
#     -p create_compartment=true \
#     -p compartment_ocid=ocid1.compartment.oc1..aaaaaaaahblyv5rr7chh3kb5utyh6c4vsvs75wg35taovjjnlftvjzgjt4qa \
#     -p service_ocid=ocid1.service.oc1.iad.aaaaaaaam4zfmy2rjue6fmglumm3czgisxzrnvrwqeodtztg7hwa272mlfna
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: oci-crossplane-test-
spec:
  serviceAccountName: argo-workflow
  entrypoint: crossplane-provider-oci-test-workflow
  volumes:
    - name: git-repo
      persistentVolumeClaim:
        claimName: git-repo-pvc
  arguments:
    parameters:
    - name: clone_repo
      value: "false"
    - name: delete_crossplane
      value: "false"
    - name: setup_crossplane
      value: "false"
    - name: run_identity_tests
      value: "false"
    - name: run_networking_tests
      value: "false"
    - name: run_loadbalancer_tests
      value: "false"
    - name: run_redis_tests
      value: "false"
    - name: run_mysql_tests
      value: "false"
    - name: run_kms_tests
      value: "false"
    - name: run_networkloadbalancer_tests
      value: "false"
    - name: run_objectstorage_tests
      value: "false"
    - name: run_psql_tests
      value: "false"
    # - name: run_certificatesmanagement_tests
    #   value: "false"
    # - name: run_compute_tests
    #   value: "false"

    # Required to clone the Crossplane OCI provider repo
    - name: git_repo
      value: https://github.com/oracle/crossplane-provider-oci.git
    - name: git_ref
      value: main
    
    # Required by scripts/setup-crossplane.sh
    - name: namespace
      value: crossplane-system
    - name: region
      value: us-ashburn-1
    - name: providers
      value: "provider-family-oci,provider-oci-certificatesmanagement,provider-oci-containerengine,provider-oci-identity,provider-oci-kms,provider-oci-loadbalancer,provider-oci-networking,provider-oci-networkloadbalancer,provider-oci-objectstorage"
    - name: provider-image-repo-name
      value: ghcr.io/oracle
    - name: family-provider-version
      value: v0.0.2
    - name: tenancy_ocid

    # Flag to create compartment in identity tests
    - name: create_compartment
      value: "false"
    # Flags to create VCN and Subnet in loadbalancer tests 
    - name: create_vcn
      value: "false"
    - name: create_subnet
      value: "false"

    # Required by create-compartment task
    - name: compartment_ocid
    # Required by create-service-gateway task in network tests
    - name: service_ocid
    # Required by create-key, create-keyversion, create-symmetrickey tasks in kms tests
    - name: vault_management_endpoint
    # Required by create-encrypteddata, create-generatedkey, create-sign tasks in kms tests
    - name: vault_crypto_endpoint

  templates:
    - name: crossplane-provider-oci-test-workflow
      dag:
        tasks:
        - name: delete-crossplane
          templateRef: 
            name: crossplane-template
            template: delete-crossplane
          when: "{{workflow.parameters.delete_crossplane}} == true"
          arguments: 
            parameters: 
              - name: namespace
                value: "{{workflow.parameters.namespace}}"
        - name: clone-repo
          templateRef: 
            name: clone-repo-template
            template: clone-repo
          when: "{{workflow.parameters.clone_repo}} == true"
          arguments: 
            parameters: 
              - name: git_repo
                value: "{{workflow.parameters.git_repo}}"
              - name: git_ref
                value: "{{workflow.parameters.git_ref}}"
        - name: check-contents
          templateRef: 
            name: clone-repo-template
            template: check-contents
          dependencies: [clone-repo]
        - name: setup-crossplane
          templateRef: 
            name: crossplane-template
            template: setup-crossplane
          dependencies: [clone-repo, delete-crossplane]
          when: "{{workflow.parameters.setup_crossplane}} == true"
          arguments:
            parameters:
              - name: namespace
                value: "{{workflow.parameters.namespace}}"
              - name: region
                value: "{{workflow.parameters.region}}"
              - name: providers
                value: "{{workflow.parameters.providers}}"
              - name: provider-image-repo-name
                value: "{{workflow.parameters.provider-image-repo-name}}"
              - name: family-provider-version
                value: "{{workflow.parameters.family-provider-version}}"
              - name: tenancy
                value: "{{workflow.parameters.tenancy_ocid}}"
        - name: identity-tests
          templateRef: 
            name: oci-identity-tests-template
            template: identity-tests-workflow
          dependencies: [setup-crossplane]
          when: "{{workflow.parameters.run_identity_tests}} == true"
          arguments:
            parameters:
              - name: create_compartment
                value: "{{workflow.parameters.create_compartment}}"
              - name: compartment_ocid
                value: "{{workflow.parameters.compartment_ocid}}"
        - name: networking-tests
          templateRef: 
            name: oci-network-tests-template
            template: network-tests-workflow
          dependencies: [setup-crossplane]
          when: "{{workflow.parameters.run_networking_tests}} == true"
          arguments:
            parameters:
              - name: create_compartment
                value: "false"
              - name: compartment_ocid
                value: "{{workflow.parameters.compartment_ocid}}"
              - name: service_ocid
                value: "{{workflow.parameters.service_ocid}}"
        - name: loadbalancer-tests
          templateRef: 
            name: oci-loadbalancer-tests-template
            template: loadbalancer-tests-workflow
          dependencies: [setup-crossplane]
          when: "{{workflow.parameters.run_loadbalancer_tests}} == true"
          arguments:
            parameters:
              - name: create_compartment
                value: "false"
              - name: create_vcn
                value: "{{workflow.parameters.create_vcn}}"
              - name: create_subnet
                value: "{{workflow.parameters.create_subnet}}"
              - name: compartment_ocid
                value: "{{workflow.parameters.compartment_ocid}}"
        - name: redis-tests
          templateRef: 
            name: oci-redis-tests-template
            template: redis-tests-workflow
          dependencies: [setup-crossplane]
          when: "{{workflow.parameters.run_redis_tests}} == true"
          arguments:
            parameters:
              - name: create_compartment
                value: "false"
              - name: create_vcn
                value: "{{workflow.parameters.create_vcn}}"
              - name: create_subnet
                value: "{{workflow.parameters.create_subnet}}"
              - name: compartment_ocid
                value: "{{workflow.parameters.compartment_ocid}}"
        - name: mysql-tests
          templateRef: 
            name: oci-mysql-tests-template
            template: mysql-tests-workflow
          dependencies: [setup-crossplane]
          when: "{{workflow.parameters.run_mysql_tests}} == true"
          arguments:
            parameters:
              - name: create_compartment
                value: "false"
              - name: create_vcn
                value: "{{workflow.parameters.create_vcn}}"
              - name: create_subnet
                value: "{{workflow.parameters.create_subnet}}"
              - name: compartment_ocid
                value: "{{workflow.parameters.compartment_ocid}}"
        - name: kms-tests
          templateRef: 
            name: oci-kms-tests-template
            template: kms-tests-workflow
          dependencies: [setup-crossplane]
          when: "{{workflow.parameters.run_kms_tests}} == true"
          arguments:
            parameters:
              - name: create_compartment
                value: "false"
              - name: compartment_ocid
                value: "{{workflow.parameters.compartment_ocid}}"
              - name: vault_management_endpoint
                value: "{{workflow.parameters.vault_management_endpoint}}"
              - name: vault_crypto_endpoint
                value: "{{workflow.parameters.vault_crypto_endpoint}}"
        - name: networkloadbalancer-tests
          templateRef: 
            name: oci-networkloadbalancer-tests-template
            template: networkloadbalancer-tests-workflow
          dependencies: [setup-crossplane]
          when: "{{workflow.parameters.run_networkloadbalancer_tests}} == true"
          arguments:
            parameters:
              - name: create_compartment
                value: "false"
              - name: create_vcn
                value: "{{workflow.parameters.create_vcn}}"
              - name: create_subnet
                value: "{{workflow.parameters.create_subnet}}"
              - name: compartment_ocid
                value: "{{workflow.parameters.compartment_ocid}}"
        - name: objectstorage-tests
          templateRef: 
            name: oci-objectstorage-tests-template
            template: objectstorage-tests-workflow
          dependencies: [setup-crossplane]
          when: "{{workflow.parameters.run_objectstorage_tests}} == true"
          arguments:
            parameters:
              - name: create_compartment
                value: "false"
              - name: compartment_ocid
                value: "{{workflow.parameters.compartment_ocid}}"
        - name: psql-tests
          templateRef:
            name: oci-psql-tests-template
            template: psql-tests-workflow
          dependencies: [setup-crossplane]
          when: "{{workflow.parameters.run_psql_tests}} == true"
          arguments:
            parameters:
              - name: create_compartment
                value: "false"
              - name: create_vcn
                value: "{{workflow.parameters.create_vcn}}"
              - name: create_subnet
                value: "{{workflow.parameters.create_subnet}}"
              - name: compartment_ocid
                value: "{{workflow.parameters.compartment_ocid}}"