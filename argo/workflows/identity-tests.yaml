#   argo submit argo/workflows/identity-tests.yaml \
#     -p create_compartment=true \
#     -p compartment_id=ocid1.compartment.oc1.xxx \
#     -p tenancy_id=ocid1.tenancy.oc1.xxx

apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: oci-identity-test-
spec:
  serviceAccountName: argo-workflow
  entrypoint: identity-tests-workflow
  volumes:
    - name: git-repo
      persistentVolumeClaim:
        claimName: git-repo-pvc
  arguments:
    parameters:
    - name: create_compartment
      value: "false"

    
    # Required by create-compartment task
    - name: compartment_ocid

    # Required by create-group, create-user task
    - name: tenancy_ocid

    # Required by create-identitydomain task
    - name: region_name

  templates:
    - name: identity-tests-workflow
      dag:
        tasks:
        - name: check-contents
          templateRef: 
            name: clone-repo-template
            template: check-contents
        - name: create-compartment
          templateRef: 
            name: test-template
            template: create-resource
          when: "{{workflow.parameters.create_compartment}} == true"
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/compartment.yaml"
              - name: envVars
                value: "COMPARTMENT_OCID={{workflow.parameters.compartment_ocid}}"
        - name: create-group
          templateRef: 
            name: test-template
            template: create-resource
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/group.yaml"
              - name: envVars
                value: "TENANCY_OCID={{workflow.parameters.tenancy_ocid}}"
        - name: create-user
          templateRef: 
            name: test-template
            template: create-resource
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/user.yaml"
              - name: envVars
                value: "TENANCY_OCID={{workflow.parameters.tenancy_ocid}}"
        - name: create-policy
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-compartment]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/policy.yaml"
        - name: create-authenticationpolicy
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-compartment]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/authenticationpolicy.yaml"
        - name: create-tagnamespace
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-compartment]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/tagnamespace.yaml"
        - name: create-tagdefault
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-compartment]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/tagdefault.yaml"
        - name: create-dynamicgroup
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-compartment]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/dynamicgroup.yaml"
        - name: create-identitydomain
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-compartment]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/identitydomain.yaml"
              - name: envVars
                value: "REGION_NAME={{workflow.parameters.region_name}}"
        - name: create-identityprovider
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-compartment]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/identityprovider.yaml"
        - name: create-networksource
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-compartment]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/networksource.yaml"
        - name: create-apikey
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-user]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/apikey.yaml"
        - name: create-authtoken
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-user]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/authtoken.yaml" 
        - name: create-customersecretkey
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-user]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/customersecretkey.yaml"
        - name: create-dbcredential
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-user]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/dbcredential.yaml"
        - name: create-smtpcredential
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-user]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/smtpcredential.yaml"
        - name: create-uipassword
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-user]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/uipassword.yaml"
        - name: create-usercapabilitiesmanagement
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-user]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/usercapabilitiesmanagement.yaml"
        - name: create-usergroupmembership
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-user, create-group]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/usergroupmembership.yaml"
        - name: create-idpgroupmapping
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-group, create-identityprovider]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/idpgroupmapping.yaml"
        - name: create-tag
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-tagnamespace]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/tag.yaml"
        - name: create-domainreplicationtoregion
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-identitydomain]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/domainreplicationtoregion.yaml"
        - name: create-importstandardtagsmanagement
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-tagnamespace]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/importstandardtagsmanagement.yaml"
