apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: oci-loadbalancer-tests-template
spec:
  serviceAccountName: argo-workflow
  entrypoint: loadbalancer-tests-workflow
  volumes:
    - name: git-repo
      persistentVolumeClaim:
        claimName: git-repo-pvc
  arguments:
    parameters:
    - name: create_compartment
      value: "false"
    - name: create_vcn
      value: "false"
    - name: create_subnet
      value: "false"

    
    # Required by create-compartment task
    - name: compartment_ocid

  templates:
    - name: loadbalancer-tests-workflow
      dag:
        tasks:
          - name: create-compartment
            templateRef:
              name: test-template
              template: create-resource
            when: "{{workflow.parameters.create_compartment}} == true"
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/identity/v1alpha1/compartment.yaml"
                - name: envVars
                  value: "COMPARTMENT_OCID={{workflow.parameters.compartment_ocid}}"
          - name: create-vcn
            templateRef: 
              name: test-template
              template: create-resource
            when: "{{workflow.parameters.create_vcn}} == true"
            dependencies: [create-compartment]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/networking/v1alpha1/vcn.yaml"
          - name: create-subnet
            templateRef: 
              name: test-template
              template: create-resource
            when: "{{workflow.parameters.create_subnet}} == true"
            dependencies: [create-compartment, create-vcn]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/networking/v1alpha1/subnet.yaml"
          - name: create-loadbalancer
            templateRef: 
              name: test-template
              template: create-resource
            dependencies: [create-compartment, create-subnet]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/loadbalancer/v1alpha1/loadbalancer.yaml"
          - name: create-backendset
            templateRef: 
              name: test-template
              template: create-resource
            dependencies: [create-loadbalancer]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/loadbalancer/v1alpha1/backendset.yaml"
          - name: create-certificate
            templateRef: 
              name: test-template
              template: create-resource
            dependencies: [create-loadbalancer]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/loadbalancer/v1alpha1/certificate.yaml"
          - name: create-lbhostname
            templateRef: 
              name: test-template
              template: create-resource
            dependencies: [create-loadbalancer]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/loadbalancer/v1alpha1/lbhostname.yaml"
          - name: create-ruleset
            templateRef: 
              name: test-template
              template: create-resource
            dependencies: [create-loadbalancer]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/loadbalancer/v1alpha1/ruleset.yaml"
          - name: create-sslciphersuite
            templateRef: 
              name: test-template
              template: create-resource
            dependencies: [create-loadbalancer]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/loadbalancer/v1alpha1/sslciphersuite.yaml"
          # - name: create-backend
          #   templateRef: 
          #     name: test-template
          #     template: create-resource
          #   dependencies: [create-loadbalancer, create-backendset]
          #   arguments:
          #     parameters:
          #       - name: resourceFile
          #         value: "examples/loadbalancer/v1alpha1/backend.yaml"
          - name: create-listener
            templateRef: 
              name: test-template
              template: create-resource
            dependencies: [create-loadbalancer, create-backendset]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/loadbalancer/v1alpha1/listener.yaml"
          - name: create-pathrouteset
            templateRef: 
              name: test-template
              template: create-resource
            dependencies: [create-loadbalancer, create-backendset]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/loadbalancer/v1alpha1/pathrouteset.yaml"
          - name: create-routingpolicy
            templateRef: 
              name: test-template
              template: create-resource
            dependencies: [create-loadbalancer, create-backendset]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/loadbalancer/v1alpha1/routingpolicy.yaml"
