apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: oci-objectstorage-tests-template
spec:
  serviceAccountName: argo-workflow
  entrypoint: objectstorage-tests-workflow
  volumes:
    - name: git-repo
      persistentVolumeClaim:
        claimName: git-repo-pvc
  arguments:
    parameters:
    - name: create_compartment
      value: "false"


    # Required by create-compartment task
    - name: compartment_ocid
    # Required by create-bucket, create-bucketwithretentionrule, create-object, create-objectlifecyclepolicy, create-preauthrequest, create-replicationpolicy tasks
    - name: objectstorage_namespace

  templates:
    - name: objectstorage-tests-workflow
      dag:
        tasks:
          - name: check-contents
            templateRef:
              name: clone-repo-template
              template: check-contents
          - name: create-compartment
            templateRef:
              name: test-template
              template: create-resource
            when: "{{workflow.parameters.create_compartment}} == true"
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/identity/v1alpha1/compartment.yaml"
                - name: envVars
                  value: "COMPARTMENT_OCID={{workflow.parameters.compartment_ocid}}"
          - name: create-bucket
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-compartment]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/objectstorage/v1alpha1/bucket.yaml"
                - name: envVars
                  value: "OBJECTSTORAGE_NAMESPACE={{workflow.parameters.objectstorage_namespace}}"
          - name: create-bucketwithretentionpolicy
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-compartment]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/objectstorage/v1alpha1/bucketwithretentionrule.yaml"
                - name: envVars
                  value: "OBJECTSTORAGE_NAMESPACE={{workflow.parameters.objectstorage_namespace}}"
          - name: create-object
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-bucket]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/objectstorage/v1alpha1/object.yaml"
                - name: envVars
                  value: "OBJECTSTORAGE_NAMESPACE={{workflow.parameters.objectstorage_namespace}}"
          - name: create-objectlifecyclepolicy
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-bucket]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/objectstorage/v1alpha1/objectlifecyclepolicy.yaml"
                - name: envVars
                  value: "OBJECTSTORAGE_NAMESPACE={{workflow.parameters.objectstorage_namespace}}"
          - name: create-preauthrequest
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-bucket]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/objectstorage/v1alpha1/preauthrequest.yaml"
                - name: envVars
                  value: "OBJECTSTORAGE_NAMESPACE={{workflow.parameters.objectstorage_namespace}}"
          - name: create-replicationpolicy
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-bucketwithretentionpolicy]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/objectstorage/v1alpha1/replicationpolicy.yaml"
                - name: envVars
                  value: "OBJECTSTORAGE_NAMESPACE={{workflow.parameters.objectstorage_namespace}}"
