apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: test-template
spec:
  templates:
    - name: create-resource
      inputs:
        parameters:
        - name: resourceFile
        - name: envVars
          value: "" # Default value, can be overridden
      container:
        image: docker.io/alpine/k8s:1.31.13
        command: [bash, -c]
        args:
        - |
          set -e
          echo "Creating resource from file: {{inputs.parameters.resourceFile}}"
          resourceKind=$(yq e '.kind' /git-repo/{{inputs.parameters.resourceFile}})
          resourceName=$(yq e '.metadata.name' /git-repo/{{inputs.parameters.resourceFile}})
          echo "Creating ${resourceKind,,} ${resourceName,,}"
          if [ -n "{{inputs.parameters.envVars}}" ]; then
            for envVar in $(echo "{{inputs.parameters.envVars}}" | tr ',' '\n'); do
              export $envVar
            done
          fi
          envsubst < /git-repo/{{inputs.parameters.resourceFile}} | kubectl apply -f - 
          echo "Validating ${resourceKind,,} ${resourceName,,} creation..."
          kubectl wait --for=condition=Ready=True ${resourceKind,,}/${resourceName,,} --timeout=900s
          kubectl describe ${resourceKind,,}/${resourceName,,} > /tmp/resource-description.txt
          cat /tmp/resource-description.txt
          echo "Resource created successfully."
        volumeMounts:
        - name: git-repo
          mountPath: /git-repo