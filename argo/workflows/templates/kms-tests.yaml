apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: oci-kms-tests-template
spec:
  serviceAccountName: argo-workflow
  entrypoint: kms-tests-workflow
  volumes:
    - name: git-repo
      persistentVolumeClaim:
        claimName: git-repo-pvc
  arguments:
    parameters:
    - name: create_compartment
      value: "false"


    # Required by create-compartment, create-key, create-asymmetrickey, create-keyversion, create-generatedkey, create-encrypteddata, create-sign tasks
    - name: compartment_ocid
    # Required by create-encrypteddata, create-generatedkey, create-sign tasks
    - name: vault_crypto_endpoint
    # Required by create-key, create-keyversion, create-symmetrickey tasks
    - name: vault_management_endpoint

  templates:
    - name: kms-tests-workflow
      dag:
        tasks:
          - name: create-compartment
            templateRef:
              name: test-template
              template: create-resource
            when: "{{workflow.parameters.create_compartment}} == true"
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/identity/v1alpha1/compartment.yaml"
                - name: envVars
                  value: "COMPARTMENT_OCID={{workflow.parameters.compartment_ocid}}"
          - name: create-vault
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-compartment]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/kms/v1alpha1/vault.yaml"
          - name: create-key
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-vault]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/kms/v1alpha1/key.yaml"
                - name: envVars
                  value: "COMPARTMENT_OCID={{workflow.parameters.compartment_ocid}},VAULT_MANAGEMENT_ENDPOINT={{workflow.parameters.vault_management_endpoint}}"
          - name: create-asymmetrickey
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-vault]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/kms/v1alpha1/asymmetrickey.yaml"
                - name: envVars
                  value: "COMPARTMENT_OCID={{workflow.parameters.compartment_ocid}},VAULT_MANAGEMENT_ENDPOINT={{workflow.parameters.vault_management_endpoint}}"
          - name: create-keyversion
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-key]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/kms/v1alpha1/keyversion.yaml"
                - name: envVars
                  value: "COMPARTMENT_OCID={{workflow.parameters.compartment_ocid}},VAULT_MANAGEMENT_ENDPOINT={{workflow.parameters.vault_management_endpoint}}"
          - name: create-generatedkey
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-key]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/kms/v1alpha1/generatedkey.yaml"
                - name: envVars
                  value: "COMPARTMENT_OCID={{workflow.parameters.compartment_ocid}},VAULT_CRYPTO_ENDPOINT={{workflow.parameters.vault_crypto_endpoint}}"
          - name: create-encrypteddata
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-key]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/kms/v1alpha1/encrypteddata.yaml"
                - name: envVars
                  value: "COMPARTMENT_OCID={{workflow.parameters.compartment_ocid}},VAULT_CRYPTO_ENDPOINT={{workflow.parameters.vault_crypto_endpoint}}"
          - name: create-sign
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-asymmetrickey]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/kms/v1alpha1/sign.yaml"
                - name: envVars
                  value: "COMPARTMENT_OCID={{workflow.parameters.compartment_ocid}},VAULT_CRYPTO_ENDPOINT={{workflow.parameters.vault_crypto_endpoint}}"
