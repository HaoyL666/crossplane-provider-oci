apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: oci-networking-tests-template
spec:
  serviceAccountName: argo-workflow
  entrypoint: networking-tests-workflow
  volumes:
    - name: git-repo
      persistentVolumeClaim:
        claimName: git-repo-pvc
  arguments:
    parameters:
    - name: create_compartment
      value: "false"    
    # Required by create-compartment task
    - name: compartment_ocid
    # TODO: To be added back after service gateway tests are fixed
    # Required by create-servicegateway task
    # - name: service_ocid # get supported services from `oci network service list`

  templates:
    - name: networking-tests-workflow
      dag:
        tasks:
        - name: create-compartment
          templateRef: 
            name: test-template
            template: create-resource
          when: "{{workflow.parameters.create_compartment}} == true"
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/identity/v1alpha1/compartment.yaml"
              - name: envVars
                value: "COMPARTMENT_OCID={{workflow.parameters.compartment_ocid}}"
        - name: create-publicippool
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-compartment]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/networking/v1alpha1/publicippool.yaml"
        - name: create-vcn
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-compartment]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/networking/v1alpha1/vcn.yaml"
        - name: create-dhcpoptions
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-compartment, create-vcn]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/networking/v1alpha1/dhcpoptions.yaml"
        - name: create-internetgateway
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-compartment, create-vcn]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/networking/v1alpha1/internetgateway.yaml" 
        - name: create-natgateway
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-compartment, create-vcn]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/networking/v1alpha1/natgateway.yaml"
        - name: create-networksecuritygroup
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-compartment, create-vcn]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/networking/v1alpha1/networksecuritygroup.yaml"
        - name: create-securitylist
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-compartment, create-vcn]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/networking/v1alpha1/securitylist.yaml"
        - name: create-subnet
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-compartment, create-vcn]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/networking/v1alpha1/subnet.yaml"
        - name: create-routetable
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-compartment, create-vcn, create-natgateway]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/networking/v1alpha1/routetable.yaml"
        # TODO: To be added back after service gateway tests are fixed
        # - name: create-servicegateway
        #   templateRef: 
        #     name: test-template
        #     template: create-resource
        #   dependencies: [create-compartment, create-routetable, create-vcn]
        #   arguments:
        #     parameters:
        #       - name: resourceFile
        #         value: "examples/networking/v1alpha1/servicegateway.yaml"
        #       - name: envVars
        #         value: "SERVICE_OCID={{workflow.parameters.service_ocid}}"
        - name: create-networksecuritygroupsecurityrule
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-networksecuritygroup]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/networking/v1alpha1/networksecuritygroupsecurityrule.yaml"
        - name: create-routetableattachment
          templateRef: 
            name: test-template
            template: create-resource
          dependencies: [create-routetable, create-subnet]
          arguments:
            parameters:
              - name: resourceFile
                value: "examples/networking/v1alpha1/routetableattachment.yaml"