apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: oci-compute-tests-template
spec:
  serviceAccountName: argo-workflow
  entrypoint: compute-tests-workflow
  volumes:
    - name: git-repo
      persistentVolumeClaim:
        claimName: git-repo-pvc
  arguments:
    parameters:
    - name: create_compartment
      value: "false"


    # Required by create-compartment task
    - name: compartment_ocid

    # Required by compute tasks
    - name: availability_domain
    - name: computecapacityreport_instanceshape
    - name: computehost_id
    - name: computeimagecapabilityschema_version_name
    - name: computeimagecapabilityschema_descriptortype
    - name: computeimagecapabilityschema_source
    - name: image_instance_ocid
    - name: instanceconsoleconnection_publickey
    - name: instancemaintenanceevent_id

  templates:
    - name: compute-tests-workflow
      dag:
        tasks:
          - name: check-contents
            templateRef:
              name: clone-repo-template
              template: check-contents
          - name: create-compartment
            templateRef:
              name: test-template
              template: create-resource
            when: "{{workflow.parameters.create_compartment}} == true"
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/identity/v1alpha1/compartment.yaml"
                - name: envVars
                  value: "COMPARTMENT_OCID={{workflow.parameters.compartment_ocid}}"
          - name: create-instancemaintenanceevent
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-compartment]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/compute/v1alpha1/instancemaintenanceevent.yaml"
                - name: envVars
                  value: "INSTANCEMAINTENANCEEVENT_ID={{workflow.parameters.instancemaintenanceevent_id}}"
          - name: create-computecapacityreservation
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-compartment]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/compute/v1alpha1/computecapacityreservation.yaml"
                - name: envVars
                  value: "AVAILABILITY_DOMAIN={{workflow.parameters.availability_domain}}"
          - name: create-computecapacitytopology
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-compartment]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/compute/v1alpha1/computecapacitytopology.yaml"
                - name: envVars
                  value: "AVAILABILITY_DOMAIN={{workflow.parameters.availability_domain}}"
          - name: create-computecapacityreport
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-compartment]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/compute/v1alpha1/computecapacityreport.yaml"
                - name: envVars
                  value: "AVAILABILITY_DOMAIN={{workflow.parameters.availability_domain}},COMPUTECAPACITYREPORT_INSTANCESHAPE={{workflow.parameters.computecapacityreport_instanceshape}}"
          - name: create-computehostgroup
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-compartment]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/compute/v1alpha1/computehostgroup.yaml"
                - name: envVars
                  value: "AVAILABILITY_DOMAIN={{workflow.parameters.availability_domain}}"
          - name: create-computehost
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-computehostgroup]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/compute/v1alpha1/computehost.yaml"
                - name: envVars
                  value: "COMPUTEHOST_ID={{workflow.parameters.computehost_id}}"
          - name: create-computeimagecapabilityschema
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-compartment]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/compute/v1alpha1/computeimagecapabilityschema.yaml"
                - name: envVars
                  value: "COMPUTEIMAGECAPABILITYSCHEMA_VERSION_NAME={{workflow.parameters.computeimagecapabilityschema_version_name}},COMPUTEIMAGECAPABILITYSCHEMA_DESCRIPTORTYPE={{workflow.parameters.computeimagecapabilityschema_descriptortype}},COMPUTEIMAGECAPABILITYSCHEMA_SOURCE={{workflow.parameters.computeimagecapabilityschema_source}}"
          - name: create-image
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-compartment]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/compute/v1alpha1/image.yaml"
                - name: envVars
                  value: "IMAGE_INSTANCE_OCID={{workflow.parameters.image_instance_ocid}}"
          - name: create-instanceconfiguration
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-compartment]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/compute/v1alpha1/instanceconfiguration.yaml"
          - name: create-instance
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-compartment]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/compute/v1alpha1/instance.yaml"
                - name: envVars
                  value: "AVAILABILITY_DOMAIN={{workflow.parameters.availability_domain}}"
          - name: create-instanceconsoleconnection
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-instance]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/compute/v1alpha1/instanceconsoleconnection.yaml"
                - name: envVars
                  value: "INSTANCECONSOLECONNECTION_PUBLICKEY={{workflow.parameters.instanceconsoleconnection_publickey}}"
          - name: create-instancepool
            templateRef:
              name: test-template
              template: create-resource
            dependencies: [create-instanceconfiguration]
            arguments:
              parameters:
                - name: resourceFile
                  value: "examples/compute/v1alpha1/instancepool.yaml"
                - name: envVars
                  value: "AVAILABILITY_DOMAIN={{workflow.parameters.availability_domain}}"
